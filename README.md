# Aspire Coding Challenge

## Default Main Task

```text
Your task is to build a mini-aspire API:
It is an app that allows authenticated users to go through a loan application. It doesn’t have to contain too many fields, but at least “amount 
required” and “loan term.” All the loans will be assumed to have a “weekly” repayment frequency.
After the loan is approved, the user must be able to submit the weekly loan repayments. It can be a simplified repay functionality, which won’t 
need to check if the dates are correct but will just set the weekly amount to be repaid.

1) Customer create a loan:
Customer submit a loan request defining amount and term 
example:

Request amount of 10.000 $ with term 3 on date 7th Feb 2022 
he will generate 3 scheduled repayments:
- 14th Feb 2022 with amount 3.333,33 $ 
- 21st Feb 2022 with amount 3.333,33 $ 
- 28th Feb 2022 with amount 3.333,34 $
the loan and scheduled repayments will have state PENDING

2) Admin approve the loan:
Admin change the pending loans to state APPROVED

3) Customer can view loan belong to him:
Add a policy check to make sure that the customers can view them own loan only.

4) Customer add a repayments:
Customer add a repayment with amount greater or equal to the scheduled repayment 
The scheduled repayment change the status to PAID

If all the scheduled repayments connected to a loan are PAID automatically also the loan become PAID
```

## My Modifications

### Generate repayment schedules only when admin approve the loan request

I want to prevent data junk which is rejected repayment schedules that won't be processed anymore.

### Admin can also reject the loan request

I think this is just logical conclusion. If Admin could approve, then they must be could reject it also.

### Customer can pay any number they want, but if the amount is less than the scheduled payment, then it won't change the repayment schedule status.

I get this idea from credit card payments. You could pay your credit card bill whatever the amount, but if you don't pay the whole amount, you will be charged with interest. I haven't implement the interest in this version.

### I send emails

I send email on events:

- loan request created
- loan request approved
- loan request rejected
- Payment success
- Payment late (by scheduler)
- All installment settled

All the contents of the email are generated by ChatGPT.

## Database design

User has many Weekly Loans.
Weekly Loans has many Repayment Schedules & Payments.

## Security

I use JWT for security & Idempotent for create a new Loan Request & Payment.

## Logging

I use [Sentry.io](https://sentry.io/) for logging. If you want to see the log, you need to update the value of `SENTRY_LARAVEL_DSN` in `.env` file.

## Hashid

I use [Hashid](https://hashids.org/) for ID masking. To change salt, change the value of `HASHIDS_SALT` in `.env` file.

## Run & Use
if you want to use it locally, then you could run this command:

```bash
composer install
php artisan serve (new terminal)
php artisan queue:listen (new terminal)
php artisan schedule:run (new terminal)
```

or

```bash
chmod +x run-local.sh
\run-local.sh
php artisan queue:listen (new terminal)
php artisan schedule:run (new terminal)
```

But, if you run locally, you have to install mailhog to test email.

Another way to run the app is with laravel sail

```bash
php artisan sail:install
./vendor/bin/sail up -d
./vendor/bin/sail artisan migrate:fresh
./vendor/bin/sail artisan db:seed
./vendor/bin/sail artisan queue:listen (new terminal)
./vendor/bin/sail artisan schedule:run (new terminal)
```

I know this is not optimal for production because we need to open new terminal/tab for queue & scheduler, but I need more time to use entrypoint.sh that I get from [Stackoverflow](https://stackoverflow.com/a/63851444) and create 2 new images for queue & scheduler. Or we could use [supervisord](http://supervisord.org/), but I don't think I got enough time to implement that.

## Important Links

### Local installation

base url to access the API :

http://localhost:8000/api;

### Docker installation

base url to access the API :

http://localhost/api;

Mailhog :

http://localhost:8025